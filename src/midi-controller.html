<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI Controller</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        h1 {
            text-align: center;
            color: #c9a227;
            margin-bottom: 10px;
        }

        .status {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 8px;
            background: #2a2a4e;
        }

        .status.connected {
            background: #1a4a2a;
        }

        .status.error {
            background: #4a1a1a;
        }

        .controller-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .knob-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background: #2a2a4e;
            border-radius: 12px;
        }

        .knob-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }

        .knob {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(145deg, #3a3a5e, #22223a);
            box-shadow:
                4px 4px 8px #15152a,
                -4px -4px 8px #3f3f6a;
            position: relative;
            cursor: grab;
            user-select: none;
        }

        .knob:active {
            cursor: grabbing;
        }

        .knob::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 12px;
            background: #c9a227;
            border-radius: 2px;
        }

        .knob-value {
            margin-top: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #c9a227;
        }

        .cc-number {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
        }

        .channel-selector {
            text-align: center;
            margin-bottom: 20px;
        }

        .channel-selector label {
            margin-right: 10px;
        }

        .channel-selector select {
            background: #2a2a4e;
            color: #eee;
            border: 1px solid #444;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }

        .instructions {
            max-width: 800px;
            margin: 30px auto 0;
            padding: 15px;
            background: #2a2a4e;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
        }

        .instructions h3 {
            margin-top: 0;
            color: #c9a227;
        }

        .instructions code {
            background: #1a1a2e;
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* Keyboard styles */
        .keyboard-section {
            max-width: 800px;
            margin: 30px auto;
        }

        .keyboard-section h2 {
            text-align: center;
            color: #c9a227;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .keyboard-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .keyboard-controls label {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .keyboard-controls select,
        .keyboard-controls input {
            background: #2a2a4e;
            color: #eee;
            border: 1px solid #444;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
        }

        .keyboard-controls input[type="number"] {
            width: 60px;
        }

        .keyboard {
            display: flex;
            justify-content: center;
            background: #2a2a4e;
            border-radius: 8px;
            padding: 15px;
        }

        .keyboard-inner {
            position: relative;
            display: flex;
        }

        .white-key {
            width: 36px;
            height: 120px;
            background: linear-gradient(to bottom, #fafafa, #e8e8e8);
            border: 1px solid #aaa;
            border-radius: 0 0 5px 5px;
            cursor: pointer;
            margin-right: 2px;
            box-shadow: 0 2px 3px rgba(0,0,0,0.2);
            position: relative;
        }

        .white-key:last-child {
            margin-right: 0;
        }

        .white-key:hover {
            background: linear-gradient(to bottom, #fff, #f5f5f5);
        }

        .white-key.active {
            background: linear-gradient(to bottom, #c9a227, #a88620);
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .white-key span {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            color: #888;
            pointer-events: none;
        }

        .black-key {
            width: 22px;
            height: 75px;
            background: linear-gradient(to bottom, #333, #111);
            border: 1px solid #000;
            border-radius: 0 0 4px 4px;
            cursor: pointer;
            position: absolute;
            top: 0;
            z-index: 2;
            box-shadow: 0 3px 5px rgba(0,0,0,0.4);
        }

        .black-key:hover {
            background: linear-gradient(to bottom, #444, #222);
        }

        .black-key.active {
            background: linear-gradient(to bottom, #c9a227, #a88620);
            box-shadow: 0 1px 2px rgba(0,0,0,0.4);
        }

        .keyboard-hint {
            text-align: center;
            margin-top: 12px;
            font-size: 11px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>MIDI Controller</h1>

    <div id="status" class="status">Initializing MIDI...</div>

    <div class="channel-selector">
        <label for="channel">MIDI Channel:</label>
        <select id="channel">
            <option value="0">Channel 1</option>
            <option value="1">Channel 2</option>
            <option value="2">Channel 3</option>
            <option value="3">Channel 4</option>
            <option value="4">Channel 5</option>
            <option value="5">Channel 6</option>
            <option value="6">Channel 7</option>
            <option value="7">Channel 8</option>
            <option value="8">Channel 9</option>
            <option value="9">Channel 10</option>
            <option value="10">Channel 11</option>
            <option value="11">Channel 12</option>
            <option value="12">Channel 13</option>
            <option value="13">Channel 14</option>
            <option value="14">Channel 15</option>
            <option value="15">Channel 16</option>
        </select>
    </div>

    <div class="controller-grid" id="knobs"></div>

    <div class="keyboard-section">
        <h2>Keyboard</h2>
        <div class="keyboard-controls">
            <label>
                Octave:
                <input type="number" id="octave" value="4" min="0" max="8">
            </label>
            <label>
                Velocity:
                <input type="number" id="velocity" value="100" min="1" max="127">
            </label>
        </div>
        <div class="keyboard" id="keyboard"></div>
        <div class="keyboard-hint">Click keys or use computer keyboard: A S D F G H J (white) / W E T Y U (black)</div>
    </div>

    <div class="instructions">
        <h3>How to Use</h3>
        <p>1. Open <strong>Audio MIDI Setup</strong> (in /Applications/Utilities/)</p>
        <p>2. Go to <strong>Window â†’ Show MIDI Studio</strong></p>
        <p>3. Double-click <strong>IAC Driver</strong> and check <strong>"Device is online"</strong></p>
        <p>4. Refresh this page - you should see "IAC Driver" in the connected devices</p>
        <p>5. Drag knobs up/down to send MIDI CC messages</p>
        <p>6. In the Eurorack app: Click <strong>MIDI Learn</strong>, click a knob, then move a knob here</p>
        <p><br>Each knob sends a different CC number (1-12). The value is shown below each knob.</p>
    </div>

    <script>
        let midiOutput = null;
        const knobValues = {};
        const CC_NUMBERS = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];

        async function initMIDI() {
            const statusEl = document.getElementById('status');

            if (!navigator.requestMIDIAccess) {
                statusEl.textContent = 'Web MIDI not supported in this browser. Use Chrome or Edge.';
                statusEl.classList.add('error');
                return;
            }

            try {
                const midiAccess = await navigator.requestMIDIAccess();

                // Find available outputs
                const outputs = Array.from(midiAccess.outputs.values());

                if (outputs.length === 0) {
                    statusEl.textContent = 'No MIDI outputs found. Enable IAC Driver in Audio MIDI Setup.';
                    statusEl.classList.add('error');
                    return;
                }

                // Prefer IAC Driver, otherwise use first output
                midiOutput = outputs.find(o => o.name.includes('IAC')) || outputs[0];

                const outputNames = outputs.map(o => o.name).join(', ');
                statusEl.textContent = `Connected to: ${midiOutput.name} (Available: ${outputNames})`;
                statusEl.classList.add('connected');

                // Listen for device changes
                midiAccess.onstatechange = () => {
                    const newOutputs = Array.from(midiAccess.outputs.values());
                    midiOutput = newOutputs.find(o => o.name.includes('IAC')) || newOutputs[0];
                    if (midiOutput) {
                        statusEl.textContent = `Connected to: ${midiOutput.name}`;
                        statusEl.classList.remove('error');
                        statusEl.classList.add('connected');
                    }
                };

            } catch (err) {
                statusEl.textContent = `MIDI Error: ${err.message}`;
                statusEl.classList.add('error');
            }
        }

        function sendCC(cc, value) {
            if (!midiOutput) return;

            const channel = parseInt(document.getElementById('channel').value);
            const status = 0xB0 + channel;  // CC message for channel

            // Send MIDI CC message: [status, cc number, value]
            midiOutput.send([status, cc, value]);

            console.log(`Sent CC ${cc} = ${value} on channel ${channel + 1}`);
        }

        function createKnobs() {
            const container = document.getElementById('knobs');

            CC_NUMBERS.forEach((cc, index) => {
                knobValues[cc] = 64;  // Start at middle

                const knobContainer = document.createElement('div');
                knobContainer.className = 'knob-container';

                knobContainer.innerHTML = `
                    <div class="knob-label">Knob ${index + 1}</div>
                    <div class="knob" data-cc="${cc}" style="transform: rotate(${valueToAngle(64)}deg)"></div>
                    <div class="knob-value" id="value-${cc}">64</div>
                    <div class="cc-number">CC ${cc}</div>
                `;

                container.appendChild(knobContainer);

                const knob = knobContainer.querySelector('.knob');
                setupKnobDrag(knob, cc);
            });
        }

        function valueToAngle(value) {
            // Map 0-127 to -135 to 135 degrees
            return (value / 127) * 270 - 135;
        }

        function setupKnobDrag(knob, cc) {
            let isDragging = false;
            let startY = 0;
            let startValue = 0;

            knob.addEventListener('mousedown', (e) => {
                isDragging = true;
                startY = e.clientY;
                startValue = knobValues[cc];
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const deltaY = startY - e.clientY;
                const deltaValue = Math.round(deltaY / 2);  // 2 pixels per step
                let newValue = Math.max(0, Math.min(127, startValue + deltaValue));

                if (newValue !== knobValues[cc]) {
                    knobValues[cc] = newValue;
                    knob.style.transform = `rotate(${valueToAngle(newValue)}deg)`;
                    document.getElementById(`value-${cc}`).textContent = newValue;
                    sendCC(cc, newValue);
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            // Double-click to reset to center
            knob.addEventListener('dblclick', () => {
                knobValues[cc] = 64;
                knob.style.transform = `rotate(${valueToAngle(64)}deg)`;
                document.getElementById(`value-${cc}`).textContent = 64;
                sendCC(cc, 64);
            });
        }

        // ============================================
        // Keyboard
        // ============================================

        // Note names for one octave (C to B)
        const WHITE_NOTES = [0, 2, 4, 5, 7, 9, 11];  // C D E F G A B
        const BLACK_NOTES = [1, 3, null, 6, 8, 10];   // C# D# (skip) F# G# A#
        const NOTE_NAMES = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];

        // Computer keyboard mapping
        const KEY_MAP = {
            'a': 0,   // C
            'w': 1,   // C#
            's': 2,   // D
            'e': 3,   // D#
            'd': 4,   // E
            'f': 5,   // F
            't': 6,   // F#
            'g': 7,   // G
            'y': 8,   // G#
            'h': 9,   // A
            'u': 10,  // A#
            'j': 11,  // B
            'k': 12,  // C (next octave)
            'o': 13,  // C#
            'l': 14,  // D
            'p': 15,  // D#
        };

        const activeNotes = new Set();
        const keyElements = {};

        function createKeyboard() {
            const container = document.getElementById('keyboard');
            const innerDiv = document.createElement('div');
            innerDiv.className = 'keyboard-inner';

            const WHITE_KEY_WIDTH = 38; // 36px + 2px margin

            // Create 2 octaves of white keys
            for (let octave = 0; octave < 2; octave++) {
                WHITE_NOTES.forEach((semitone, index) => {
                    const key = document.createElement('div');
                    key.className = 'white-key';
                    const actualSemitone = semitone + (octave * 12);
                    key.dataset.semitone = actualSemitone;
                    key.innerHTML = `<span>${NOTE_NAMES[index]}${octave === 0 ? '' : "'"}</span>`;
                    innerDiv.appendChild(key);
                    keyElements[actualSemitone] = key;
                    setupKeyEvents(key, actualSemitone);
                });
            }

            // Black key positions relative to start of each octave
            // Each white key is 38px wide (36 + 2 margin)
            // Black keys sit between: C#(after C), D#(after D), F#(after F), G#(after G), A#(after A)
            const blackKeyOffsets = [
                { semitone: 1, whiteKeyIndex: 0 },   // C# after C
                { semitone: 3, whiteKeyIndex: 1 },   // D# after D
                { semitone: 6, whiteKeyIndex: 3 },   // F# after F
                { semitone: 8, whiteKeyIndex: 4 },   // G# after G
                { semitone: 10, whiteKeyIndex: 5 },  // A# after A
            ];

            // Create black keys for both octaves
            for (let octave = 0; octave < 2; octave++) {
                const octaveOffset = octave * 7 * WHITE_KEY_WIDTH;

                blackKeyOffsets.forEach(({ semitone, whiteKeyIndex }) => {
                    const key = document.createElement('div');
                    key.className = 'black-key';
                    const actualSemitone = semitone + (octave * 12);
                    key.dataset.semitone = actualSemitone;
                    // Position: after the white key, minus half the black key width
                    const leftPos = octaveOffset + (whiteKeyIndex + 1) * WHITE_KEY_WIDTH - 13;
                    key.style.left = `${leftPos}px`;
                    innerDiv.appendChild(key);
                    keyElements[actualSemitone] = key;
                    setupKeyEvents(key, actualSemitone);
                });
            }

            container.appendChild(innerDiv);
        }

        function setupKeyEvents(keyElement, semitone) {
            keyElement.addEventListener('mousedown', (e) => {
                e.preventDefault();
                noteOn(semitone);
            });

            keyElement.addEventListener('mouseup', () => {
                noteOff(semitone);
            });

            keyElement.addEventListener('mouseleave', () => {
                if (activeNotes.has(semitone)) {
                    noteOff(semitone);
                }
            });

            keyElement.addEventListener('mouseenter', (e) => {
                if (e.buttons === 1) {
                    noteOn(semitone);
                }
            });
        }

        function getMidiNote(semitone) {
            const octave = parseInt(document.getElementById('octave').value);
            return (octave + 1) * 12 + semitone;  // MIDI note number
        }

        function noteOn(semitone) {
            if (activeNotes.has(semitone)) return;

            const midiNote = getMidiNote(semitone);
            const velocity = parseInt(document.getElementById('velocity').value);

            sendNoteOn(midiNote, velocity);
            activeNotes.add(semitone);

            if (keyElements[semitone]) {
                keyElements[semitone].classList.add('active');
            }
        }

        function noteOff(semitone) {
            if (!activeNotes.has(semitone)) return;

            const midiNote = getMidiNote(semitone);

            sendNoteOff(midiNote);
            activeNotes.delete(semitone);

            if (keyElements[semitone]) {
                keyElements[semitone].classList.remove('active');
            }
        }

        function sendNoteOn(note, velocity) {
            if (!midiOutput) return;

            const channel = parseInt(document.getElementById('channel').value);
            const status = 0x90 + channel;  // Note On

            midiOutput.send([status, note, velocity]);
            console.log(`Note On: ${note} vel=${velocity} ch=${channel + 1}`);
        }

        function sendNoteOff(note) {
            if (!midiOutput) return;

            const channel = parseInt(document.getElementById('channel').value);
            const status = 0x80 + channel;  // Note Off

            midiOutput.send([status, note, 0]);
            console.log(`Note Off: ${note} ch=${channel + 1}`);
        }

        // Computer keyboard support
        document.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            const semitone = KEY_MAP[e.key.toLowerCase()];
            if (semitone !== undefined) {
                e.preventDefault();
                noteOn(semitone);
            }

            // Octave up/down with Z and X
            if (e.key.toLowerCase() === 'z') {
                const octaveInput = document.getElementById('octave');
                octaveInput.value = Math.max(0, parseInt(octaveInput.value) - 1);
            }
            if (e.key.toLowerCase() === 'x') {
                const octaveInput = document.getElementById('octave');
                octaveInput.value = Math.min(8, parseInt(octaveInput.value) + 1);
            }
        });

        document.addEventListener('keyup', (e) => {
            const semitone = KEY_MAP[e.key.toLowerCase()];
            if (semitone !== undefined) {
                noteOff(semitone);
            }
        });

        // Initialize
        createKnobs();
        createKeyboard();
        initMIDI();
    </script>
</body>
</html>
